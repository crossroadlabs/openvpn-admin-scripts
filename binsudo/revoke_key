#!/bin/bash
set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source "$DIR/../config.sh"
source "$DIR/../utils/user.sh"
source "$OPENVPN_VARS"

name=$(cleanup_username "$1")

export EASY_RSA="${EASY_RSA:-.}"

result=$("$EASY_RSA/revoke-full" "$name")
echo "$result"
revoked=$(echo "$result" | grep "certificate revoked" > /dev/null; echo "$?")

if [ "$revoked" != "0" ] ; then
	echo "Error: Can't revoke. Check openssl output"
	exit 1
fi

if [ -f "$KEY_DIR/$name.key" ] ; then
	rm "$KEY_DIR/$name".*
fi

if [ -f "$OPENVPN_KEY_BACKUP_DIR/$name.key" ] ; then
	rm "$OPENVPN_KEY_BACKUP_DIR/$name".*
fi
